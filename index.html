<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rate of Reaction: Acid Concentration</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom slider styling for better touch targets */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            margin: 10px 0;
        }
        input[type=range]:focus {
            outline: none;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 4px;
        }
        input[type=range]::-webkit-slider-thumb {
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range].range-red::-webkit-slider-thumb {
            background: #ef4444;
        }
        input[type=range].range-timeline::-webkit-slider-thumb {
            background: #d97706; /* Yellow-600 */
            height: 16px;
            width: 16px;
            margin-top: -4px;
        }

        /* Prevent text selection during interaction */
        .no-select {
            user-select: none;
            -webkit-user-select: none;
        }

        /* Canvas borders */
        canvas {
            touch-action: none;
        }
        
        /* Liquid transitions */
        .liquid-level {
            transition: height 0.5s ease-out;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-slate-900 text-white p-3 shadow-md flex justify-between items-center z-10 shrink-0 gap-4">
        <div class="shrink-0">
            <h1 class="text-lg md:text-xl font-bold flex items-center gap-2">
                <span class="text-2xl">‚öóÔ∏è</span> Excess Mg vs. Excess HCl
            </h1>
            <p class="text-xs text-slate-400 hidden md:block">Rate of Reaction Simulation</p>
        </div>
        
        <!-- Timeline Scrubber (Visible when running/paused) -->
        <div id="timelineContainer" class="flex-1 max-w-md hidden flex items-center gap-2">
            <span class="text-xs text-yellow-500 font-bold whitespace-nowrap">Time</span>
            <input type="range" id="timeline" class="range-timeline" min="0" max="120" step="0.1" value="0">
        </div>

        <div class="flex gap-2 shrink-0">
            <button id="previewBtn" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1 rounded text-sm font-bold shadow transition-colors flex items-center gap-1 border border-indigo-400">
                üëÅ Preview
            </button>
            <button id="pauseBtn" class="bg-yellow-600 hover:bg-yellow-500 text-white px-3 py-1 rounded text-sm font-bold shadow transition-colors hidden">
                ‚è∏ Pause
            </button>
            <button id="resetBtn" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded text-sm font-medium transition-colors">
                ‚Ü∫ Reset
            </button>
            <button id="startBtn" class="bg-green-600 hover:bg-green-500 text-white px-4 py-1 rounded text-sm font-bold shadow transition-colors">
                ‚ñ∂ Start
            </button>
        </div>
    </header>

    <!-- Main Content Grid -->
    <main class="flex-1 overflow-hidden flex flex-col md:flex-row relative">
        
        <!-- Left Panel: Controls -->
        <aside class="w-full md:w-1/3 lg:w-1/4 bg-white border-r border-slate-200 overflow-y-auto p-4 shadow-inner z-10">
            
            <!-- Scenario Selector -->
            <div class="mb-6">
                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Select Scenario</label>
                <select id="scenarioSelect" class="w-full p-2 border border-slate-300 rounded bg-slate-50 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    <option value="excess_mg">Excess Mg</option>
                    <option value="excess_hcl">Excess HCl</option>
                    <option value="custom">üõ†Ô∏è Custom Setup</option>
                </select>
            </div>

            <!-- Experiment A Controls -->
            <div class="mb-4 border-l-4 border-blue-500 pl-3 py-1 bg-blue-50 rounded-r">
                <h3 class="font-bold text-blue-800 flex justify-between items-center">
                    Experiment A (Blue)
                </h3>
                
                <div class="mt-3 space-y-3">
                    <div>
                        <div class="flex justify-between items-end mb-1">
                            <span class="text-xs">Acid Concentration (mol/dm¬≥)</span>
                            <span id="val-conc-a" class="font-mono font-bold text-lg text-blue-900 mr-2">1.0</span>
                        </div>
                        <input type="range" id="slider-conc-a" min="0.1" max="3.0" step="0.1" value="1.0">
                    </div>

                    <div>
                        <div class="flex justify-between items-end mb-1">
                            <span class="text-xs">Volume of Acid (cm¬≥)</span>
                            <span id="val-vol-a" class="font-mono font-bold text-lg text-blue-900 mr-2">50</span>
                        </div>
                        <input type="range" id="slider-vol-a" min="10" max="100" step="5" value="50">
                    </div>

                    <div>
                        <div class="flex justify-between items-end mb-1">
                            <span class="text-xs">Mass of Mg metal (g)</span>
                            <span id="val-mass-a" class="font-mono font-bold text-lg text-blue-900 mr-2">2.0</span>
                        </div>
                        <input type="range" id="slider-mass-a" min="0.5" max="3.0" step="0.1" value="2.0">
                    </div>

                    <div class="flex gap-2 text-xs">
                        <label class="flex items-center gap-1 cursor-pointer">
                            <input type="checkbox" id="chk-powder-a" class="accent-blue-600">
                            <span>Powder</span>
                        </label>
                        <label class="flex items-center gap-1 cursor-pointer">
                            <input type="checkbox" id="chk-weak-a" class="accent-blue-600">
                            <span>Weak Acid</span>
                        </label>
                        <label class="flex items-center gap-1 cursor-pointer">
                            <input type="checkbox" id="chk-dibasic-a" class="accent-blue-600">
                            <span>Dibasic</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Experiment B Controls -->
            <div class="mb-4 border-l-4 border-red-500 pl-3 py-1 bg-red-50 rounded-r">
                <h3 class="font-bold text-red-800 flex justify-between items-center">
                    Experiment B (Red)
                </h3>
                
                <div class="mt-3 space-y-3">
                    <div>
                        <div class="flex justify-between items-end mb-1">
                            <span class="text-xs">Acid Concentration (mol/dm¬≥)</span>
                            <span id="val-conc-b" class="font-mono font-bold text-lg text-red-900 mr-2">2.0</span>
                        </div>
                        <input type="range" id="slider-conc-b" class="range-red" min="0.1" max="3.0" step="0.1" value="2.0">
                    </div>

                    <div>
                        <div class="flex justify-between items-end mb-1">
                            <span class="text-xs">Volume of Acid (cm¬≥)</span>
                            <span id="val-vol-b" class="font-mono font-bold text-lg text-red-900 mr-2">50</span>
                        </div>
                        <input type="range" id="slider-vol-b" class="range-red" min="10" max="100" step="5" value="50">
                    </div>

                    <div>
                        <div class="flex justify-between items-end mb-1">
                            <span class="text-xs">Mass of Mg metal (g)</span>
                            <span id="val-mass-b" class="font-mono font-bold text-lg text-red-900 mr-2">2.0</span>
                        </div>
                        <input type="range" id="slider-mass-b" class="range-red" min="0.5" max="3.0" step="0.1" value="2.0">
                    </div>

                    <div class="flex gap-2 text-xs">
                        <label class="flex items-center gap-1 cursor-pointer">
                            <input type="checkbox" id="chk-powder-b" class="accent-red-600">
                            <span>Powder</span>
                        </label>
                        <label class="flex items-center gap-1 cursor-pointer">
                            <input type="checkbox" id="chk-weak-b" class="accent-red-600">
                            <span>Weak Acid</span>
                        </label>
                        <label class="flex items-center gap-1 cursor-pointer">
                            <input type="checkbox" id="chk-dibasic-b" class="accent-red-600">
                            <span>Dibasic</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Fixed Parameters Note -->
            <div class="text-xs text-slate-500 italic mt-2 p-2 bg-slate-100 rounded">
                *Temperature constant at 25¬∞C<br>
                *Default acid is hydrochloric acid
            </div>

        </aside>

        <!-- Right Panel: Visualization -->
        <div class="flex-1 flex flex-col bg-slate-100 relative overflow-hidden">
            
            <!-- Graph Area (Increased height to 50%) -->
            <div class="h-[50%] p-2 relative bg-white m-1 rounded-lg shadow-sm border border-slate-200 min-h-[200px]">
                <canvas id="graphCanvas" class="w-full h-full block cursor-crosshair"></canvas>
                <!-- Tooltip Overlay -->
                <div id="graphTooltip" class="absolute pointer-events-none hidden bg-black/80 text-white text-xs p-2 rounded z-20 top-0 left-0"></div>
                
                <!-- Graph Labels -->
                <div class="absolute bottom-5 right-4 text-xs font-bold text-black">Time/s</div>
                <div class="absolute top-1 left-2 text-xs font-bold text-black bg-white/90 px-1 rounded z-10 whitespace-nowrap border border-transparent">
                    Volume of gas/cm¬≥
                </div>

                <!-- Legend: Spelled out Experiment -->
                <div class="absolute top-2 right-4 flex gap-4 text-xs font-bold">
                    <span class="text-blue-600 flex items-center">‚óè Experiment A</span>
                    <span class="text-red-600 flex items-center">‚óè Experiment B</span>
                </div>
            </div>

            <!-- Beaker Animation Area -->
            <div class="flex-1 shrink-0 flex items-end justify-center gap-12 pb-16 relative overflow-hidden">
                <!-- Background Decoration -->
                <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px;"></div>

                <!-- Beaker A -->
                <div class="relative w-32 h-48 flex flex-col items-center">
                    <div class="text-blue-600 font-bold mb-1 text-lg">A</div>
                    <div class="w-full h-full border-b-4 border-x-2 border-slate-400 rounded-b-xl relative bg-white/50 backdrop-blur-sm overflow-hidden shadow-lg">
                        <!-- Liquid -->
                        <div id="liquid-a" class="absolute bottom-0 w-full h-32 liquid-level bg-blue-100/60 border-t border-blue-200"></div>
                        <!-- Metal -->
                        <div id="metal-a" class="absolute bottom-0 left-1/2 -translate-x-1/2 w-12 h-2 bg-slate-400 transition-all"></div>
                        <!-- Bubbles Canvas -->
                        <canvas id="bubblesA" class="absolute inset-0 w-full h-full pointer-events-none"></canvas>
                    </div>
                </div>

                <!-- Beaker B -->
                <div class="relative w-32 h-48 flex flex-col items-center">
                    <div class="text-red-600 font-bold mb-1 text-lg">B</div>
                    <div class="w-full h-full border-b-4 border-x-2 border-slate-400 rounded-b-xl relative bg-white/50 backdrop-blur-sm overflow-hidden shadow-lg">
                        <!-- Liquid -->
                        <div id="liquid-b" class="absolute bottom-0 w-full h-32 liquid-level bg-red-100/60 border-t border-red-200"></div>
                        <!-- Metal -->
                        <div id="metal-b" class="absolute bottom-0 left-1/2 -translate-x-1/2 w-12 h-2 bg-slate-400 transition-all"></div>
                         <!-- Bubbles Canvas -->
                         <canvas id="bubblesB" class="absolute inset-0 w-full h-full pointer-events-none"></canvas>
                    </div>
                </div>
            </div>

            <!-- Real-time Values Overlay -->
            <div class="absolute bottom-0 left-0 w-full p-2 bg-slate-900/80 text-white text-xs flex justify-around backdrop-blur z-0">
                <div class="text-center">
                    <span class="text-slate-400">Time</span><br>
                    <span id="display-time" class="font-mono text-lg">0.0</span> s
                </div>
                <div class="text-center text-blue-300">
                    <span class="opacity-70">Vol A</span><br>
                    <span id="display-vol-a" class="font-mono text-lg">0</span> cm¬≥
                </div>
                <div class="text-center text-red-300">
                    <span class="opacity-70">Vol B</span><br>
                    <span id="display-vol-b" class="font-mono text-lg">0</span> cm¬≥
                </div>
            </div>

        </div>
    </main>

    <!-- JavaScript Implementation -->
    <script>
        /**
         * RATE OF REACTION SIMULATION
         * * Scientific Model:
         * Reaction: Mg(s) + 2HCl(aq) -> MgCl2(aq) + H2(g)
         */

        // --- CONSTANTS ---
        const MOLAR_MASS_MG = 24.0; // g/mol (Simplified per instruction)
        const MOLAR_VOL_GAS = 24000; // cm3/mol at r.t.p
        const MAX_TIME = 120; // seconds on graph
        
        // --- STATE ---
        const state = {
            isRunning: false,
            isPaused: false,
            showPreview: false,
            currentTime: 0, 
            simSpeed: 1,
            startTime: Date.now(),
            
            expA: { mass: 2.0, conc: 1.0, volAcid: 50, isPowder: false, isWeak: false, isDibasic: false, maxVol: 0, k: 0, currentVol: 0 },
            expB: { mass: 2.0, conc: 2.0, volAcid: 50, isPowder: false, isWeak: false, isDibasic: false, maxVol: 0, k: 0, currentVol: 0 }
        };

        // --- DOM ELEMENTS ---
        const els = {
            btnStart: document.getElementById('startBtn'),
            btnReset: document.getElementById('resetBtn'),
            btnPause: document.getElementById('pauseBtn'),
            btnPreview: document.getElementById('previewBtn'),
            timeline: document.getElementById('timeline'),
            timelineContainer: document.getElementById('timelineContainer'),
            scenario: document.getElementById('scenarioSelect'),
            graphCanvas: document.getElementById('graphCanvas'),
            bubblesA: document.getElementById('bubblesA'),
            bubblesB: document.getElementById('bubblesB'),
            
            // Visual Elements
            liquidA: document.getElementById('liquid-a'),
            liquidB: document.getElementById('liquid-b'),

            // Inputs A & B
            sliderConcA: document.getElementById('slider-conc-a'), 
            sliderVolA: document.getElementById('slider-vol-a'),
            sliderMassA: document.getElementById('slider-mass-a'),
            chkPowderA: document.getElementById('chk-powder-a'), chkWeakA: document.getElementById('chk-weak-a'), chkDibasicA: document.getElementById('chk-dibasic-a'),
            valConcA: document.getElementById('val-conc-a'), 
            valVolA: document.getElementById('val-vol-a'),
            valMassA: document.getElementById('val-mass-a'),
            
            sliderConcB: document.getElementById('slider-conc-b'), 
            sliderVolB: document.getElementById('slider-vol-b'),
            sliderMassB: document.getElementById('slider-mass-b'),
            chkPowderB: document.getElementById('chk-powder-b'), chkWeakB: document.getElementById('chk-weak-b'), chkDibasicB: document.getElementById('chk-dibasic-b'),
            valConcB: document.getElementById('val-conc-b'), 
            valVolB: document.getElementById('val-vol-b'),
            valMassB: document.getElementById('val-mass-b'),

            // Displays
            dispTime: document.getElementById('display-time'),
            dispVolA: document.getElementById('display-vol-a'), dispVolB: document.getElementById('display-vol-b'),
            metalA: document.getElementById('metal-a'), metalB: document.getElementById('metal-b')
        };

        // --- INITIALIZATION ---
        function init() {
            resizeCanvases();
            window.addEventListener('resize', resizeCanvases);
            
            setupInputListeners('A');
            setupInputListeners('B');
            
            els.btnStart.addEventListener('click', toggleSimulation);
            els.btnReset.addEventListener('click', resetSimulation);
            els.btnPause.addEventListener('click', togglePause);
            els.btnPreview.addEventListener('click', togglePreview);
            els.scenario.addEventListener('change', applyScenario);
            
            // Timeline Scrubber Logic
            els.timeline.addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                state.currentTime = val;
                
                // If interacting before start, treat as paused run
                if (!state.isRunning) {
                     state.isRunning = true;
                     state.isPaused = true;
                     els.btnStart.classList.add('hidden');
                     els.btnPause.classList.remove('hidden');
                     els.btnPause.innerHTML = "‚ñ∂ Resume";
                     els.btnPause.classList.replace('bg-yellow-600', 'bg-green-600');
                     els.btnPause.classList.replace('hover:bg-yellow-500', 'hover:bg-green-500');
                     els.timelineContainer.classList.remove('hidden');
                     els.btnPreview.classList.add('hidden');
                     document.querySelectorAll('input:not(.range-timeline), select').forEach(el => el.disabled = true);
                }

                updateVolume(state.expA);
                updateVolume(state.expB);
                
                els.dispTime.textContent = state.currentTime.toFixed(1);
                els.dispVolA.textContent = state.expA.currentVol.toFixed(1);
                els.dispVolB.textContent = state.expB.currentVol.toFixed(1);
                
                drawGraph(true);
                animateBubbles(state.expA, els.bubblesA, 'blue');
                animateBubbles(state.expB, els.bubblesB, 'red');
                shrinkMetal();
            });

            // Initialize with default scenario (Limiting)
            applyScenario();
        }

        function setupInputListeners(exp) {
            const inputs = [`sliderConc${exp}`, `sliderVol${exp}`, `sliderMass${exp}`, `chkPowder${exp}`, `chkWeak${exp}`, `chkDibasic${exp}`];
            inputs.forEach(id => {
                const el = els[id];
                const eventType = el.type === 'checkbox' ? 'change' : 'input';
                el.addEventListener(eventType, (e) => {
                    if (state.isRunning) return; 
                    
                    const key = id.replace(`slider`, '').replace(`chk`, '').toLowerCase();
                    const param = key.slice(0, -1); 
                    if (el.type === 'range') document.getElementById(`val-${param}-${exp.toLowerCase()}`).textContent = el.value;
                    
                    const val = el.type === 'checkbox' ? el.checked : parseFloat(el.value);
                    const stateKey = exp === 'A' ? 'expA' : 'expB';
                    
                    let prop = '';
                    if (param === 'conc') prop = 'conc';
                    else if (param === 'vol') prop = 'volAcid';
                    else if (param === 'mass') prop = 'mass';
                    else if (param.includes('powder')) prop = 'isPowder';
                    else if (param.includes('weak')) prop = 'isWeak';
                    else if (param.includes('dibasic')) prop = 'isDibasic';
                    
                    state[stateKey][prop] = val;
                    if (prop === 'isWeak' && val) els[`chkDibasic${exp}`].checked = false;
                    if (prop === 'isDibasic' && val) els[`chkWeak${exp}`].checked = false;
                    els.scenario.value = 'custom';
                    state.showPreview = false; // Turn off preview if params change
                    
                    updateCalculations();
                    updateMetalVisuals();
                    updateLiquidVisuals();
                    drawGraph(); 
                });
            });
        }

        // --- LOGIC & CALCULATIONS ---
        function updateCalculations() {
            calculateReactionData(state.expA);
            calculateReactionData(state.expB);
        }

        function calculateReactionData(exp) {
            // STRICT STOICHIOMETRIC & KINETIC LOGIC

            // Inputs
            const acidVol = exp.volAcid; // cm3
            const acidConc = exp.conc; // mol/dm3
            const basicity = exp.isDibasic ? 2 : 1;
            const massMg = exp.mass; // g
            const isPowder = exp.isPowder;
            const isWeak = exp.isWeak;

            // --- Step 1: Stoichiometry (Yield) ---
            
            // Moles
            const molMg = massMg / MOLAR_MASS_MG; 
            const molAcidMolecule = (acidVol / 1000) * acidConc;
            
            // H+ available for reaction (Stoichiometry)
            const totalMolHPlus = molAcidMolecule * basicity;
            const molHPlusNeeded = molMg * 2; // Mg + 2H+ -> Mg2+ + H2

            let molH2 = 0;
            let limitingReactant = '';

            if (totalMolHPlus >= molHPlusNeeded) {
                // Mg is limiting
                limitingReactant = 'Mg';
                molH2 = molMg;
            } else {
                // Acid is limiting
                limitingReactant = 'Acid';
                molH2 = totalMolHPlus / 2;
            }

            const vFinal = molH2 * MOLAR_VOL_GAS;
            exp.maxVol = vFinal;
            exp.limiting = limitingReactant;

            // --- Step 2: Kinetics (Rate/Slope) ---

            // Concentration of H+ ions (The primary factor for Initial Rate)
            // Strong Acid: [H+] = Conc * Basicity
            // Weak Acid: Dissociates partially, so effective [H+] is lower
            let effectiveHPlusConc = acidConc * basicity;
            if (isWeak) {
                effectiveHPlusConc *= 0.1; // Weak acid approximation
            }

            // Base Rate Factor
            // Arbitrary scaling factor to map concentration to pixels/sec on the canvas
            // Value of 15.0 ensures 1.0M HCl finishes in approx 80s
            let rateFactor = 15.0; 

            // Surface Area Effect
            if (isPowder) {
                rateFactor *= 5.0; 
            }

            // Target Initial Slope (Rate at t=0)
            // Rate = k_chem * [H+] * SurfaceArea
            // We enforce that Slope is directly proportional to [H+]
            const targetInitialSlope = effectiveHPlusConc * rateFactor;

            // Derive k for the exponential formula: V(t) = Vmax * (1 - e^-kt)
            // The derivative (slope) at t=0 is: Slope = Vmax * k
            // Therefore: k = Slope / Vmax
            // This ensures the graph starts with the correct steepness regardless of final volume.
            
            if (vFinal > 0.1) {
                exp.k = targetInitialSlope / vFinal;
                
                // Safety cap for physics engine (prevents instant infinity loops)
                if (exp.k > 10) exp.k = 10;
            } else {
                exp.k = 0;
            }
        }

        function applyScenario() {
            const mode = els.scenario.value;
            if (mode === 'custom') return;
            const base = { mass: 2.0, conc: 1.0, volAcid: 50, isPowder: false, isWeak: false, isDibasic: false };
            Object.assign(state.expA, base);
            Object.assign(state.expB, base);

            switch (mode) {
                case 'excess_mg': 
                    // Mg Excess (2g), Acid Limiting. Conc B higher (2M).
                    state.expB.mass = 2.0; 
                    state.expB.conc = 2.0;
                    break;
                case 'excess_hcl':
                    // HCl Excess, Mg Limiting (0.5g). Conc B higher (2M).
                    state.expA.mass = 0.5;
                    state.expB.mass = 0.5;
                    state.expB.conc = 2.0;
                    break;
            }
            syncUI();
            updateCalculations();
            updateMetalVisuals();
            updateLiquidVisuals();
            state.showPreview = false;
            drawGraph();
        }

        function syncUI() {
            ['A', 'B'].forEach(exp => {
                const s = exp === 'A' ? state.expA : state.expB;
                els[`sliderConc${exp}`].value = s.conc;
                els[`valConc${exp}`].textContent = s.conc;
                els[`sliderVol${exp}`].value = s.volAcid;
                els[`valVol${exp}`].textContent = s.volAcid;
                els[`sliderMass${exp}`].value = s.mass;
                els[`valMass${exp}`].textContent = s.mass;
                els[`chkPowder${exp}`].checked = s.isPowder;
                els[`chkWeak${exp}`].checked = s.isWeak;
                els[`chkDibasic${exp}`].checked = s.isDibasic;
            });
        }

        // --- SIMULATION LOOP ---
        function toggleSimulation() {
            if (state.isRunning) return;
            state.isRunning = true;
            state.isPaused = false;
            state.showPreview = false;
            state.startTime = Date.now();
            
            document.querySelectorAll('input:not(.range-timeline), select').forEach(el => el.disabled = true);
            els.btnStart.classList.add('hidden');
            els.btnPause.classList.remove('hidden');
            els.timelineContainer.classList.remove('hidden');
            els.btnPreview.classList.add('hidden'); 
            
            requestAnimationFrame(gameLoop);
        }

        function togglePause() {
            state.isPaused = !state.isPaused;
            if (state.isPaused) {
                els.btnPause.innerHTML = "‚ñ∂ Resume";
                els.btnPause.classList.replace('bg-yellow-600', 'bg-green-600');
                els.btnPause.classList.replace('hover:bg-yellow-500', 'hover:bg-green-500');
            } else {
                els.btnPause.innerHTML = "‚è∏ Pause";
                els.btnPause.classList.replace('bg-green-600', 'bg-yellow-600');
                els.btnPause.classList.replace('hover:bg-green-500', 'hover:bg-yellow-500');
                // Adjust start time so no jump occurs
                state.startTime = Date.now() - (state.currentTime / state.simSpeed * 1000); 
                requestAnimationFrame(gameLoop);
            }
        }
        
        function togglePreview() {
            if (state.isRunning) return;
            state.showPreview = !state.showPreview;
            drawGraph();
        }

        function resetSimulation() {
            state.isRunning = false;
            state.isPaused = false;
            state.showPreview = false;
            state.currentTime = 0;
            state.expA.currentVol = 0;
            state.expB.currentVol = 0;
            
            document.querySelectorAll('input, select').forEach(el => el.disabled = false);
            els.timeline.value = 0;
            
            els.btnStart.classList.remove('hidden');
            els.btnStart.innerHTML = "‚ñ∂ Start";
            els.btnStart.classList.remove('opacity-50', 'cursor-not-allowed');
            els.btnPause.classList.add('hidden');
            els.btnPause.innerHTML = "‚è∏ Pause";
            els.btnPause.classList.replace('bg-green-600', 'bg-yellow-600'); 
            els.timelineContainer.classList.add('hidden');
            els.btnPreview.classList.remove('hidden');
            
            els.dispTime.textContent = "0.0";
            els.dispVolA.textContent = "0";
            els.dispVolB.textContent = "0";
            
            updateMetalVisuals();
            drawGraph();
            const ctxA = els.bubblesA.getContext('2d');
            const ctxB = els.bubblesB.getContext('2d');
            ctxA.clearRect(0,0,els.bubblesA.width, els.bubblesA.height);
            ctxB.clearRect(0,0,els.bubblesB.width, els.bubblesB.height);
        }

        function gameLoop() {
            if (!state.isRunning) return;
            if (state.isPaused) return;

            state.currentTime += 0.05; 
            
            // Sync slider to time
            els.timeline.value = state.currentTime;

            updateVolume(state.expA);
            updateVolume(state.expB);
            
            els.dispTime.textContent = state.currentTime.toFixed(1);
            els.dispVolA.textContent = state.expA.currentVol.toFixed(1);
            els.dispVolB.textContent = state.expB.currentVol.toFixed(1);
            
            drawGraph(true);
            animateBubbles(state.expA, els.bubblesA, 'blue');
            animateBubbles(state.expB, els.bubblesB, 'red');
            shrinkMetal();

            if (state.currentTime >= MAX_TIME) {
                state.isRunning = false;
                els.btnPause.classList.add('hidden');
                // No Refinish button showed as requested
            } else {
                requestAnimationFrame(gameLoop);
            }
        }

        function updateVolume(exp) {
            // First-Order Approach formula: V(t) = Vfinal * (1 - e^(-kt))
            exp.currentVol = exp.maxVol * (1 - Math.exp(-exp.k * state.currentTime));
        }

        // --- VISUALIZATION ---
        function updateLiquidVisuals() {
            // Beaker max height is h-32 (8rem approx 128px) or h-48 container
            // Let's assume 100cm3 = 80% of beaker height
            const setHeight = (el, vol) => {
                const percentage = (vol / 120) * 100; // 100cm3 fills most of it
                el.style.height = `${Math.max(10, percentage)}%`;
            };
            setHeight(els.liquidA, state.expA.volAcid);
            setHeight(els.liquidB, state.expB.volAcid);
        }

        function updateMetalVisuals() {
            updateSingleMetal(els.metalA, state.expA);
            updateSingleMetal(els.metalB, state.expB);
        }

        function updateSingleMetal(el, exp) {
            const w = 20 + (exp.mass * 100); 
            el.style.width = `${Math.min(w, 80)}%`; 
            el.style.opacity = '1';
            if (exp.isPowder) {
                el.style.height = '12px';
                el.style.background = 'transparent';
                el.style.backgroundImage = 'radial-gradient(circle, #64748b 2px, transparent 2.5px)';
                el.style.backgroundSize = '6px 6px';
                el.style.borderRadius = '0';
            } else {
                el.style.height = '6px';
                el.style.background = '#64748b';
                el.style.backgroundImage = 'none';
                el.style.borderRadius = '2px';
            }
        }

        function shrinkMetal() {
            shrinkSingleMetal(els.metalA, state.expA);
            shrinkSingleMetal(els.metalB, state.expB);
        }

        function shrinkSingleMetal(el, exp) {
            const molH2Produced = exp.currentVol / MOLAR_VOL_GAS;
            const molMgReacted = molH2Produced; 
            const initialMolMg = exp.mass / MOLAR_MASS_MG;
            const fractionRemaining = Math.max(0, (initialMolMg - molMgReacted) / initialMolMg);
            el.style.opacity = fractionRemaining;
        }

        // --- GRAPHING ---
        function drawGraph(animateLine = false) {
            const cvs = els.graphCanvas;
            const ctx = cvs.getContext('2d');
            const w = cvs.width;
            const h = cvs.height;
            const pad = 30;
            
            ctx.clearRect(0, 0, w, h);
            
            // Changed axis color to black (#000000)
            ctx.beginPath(); 
            ctx.strokeStyle = '#000000'; 
            ctx.lineWidth = 1;
            ctx.moveTo(pad, 10); ctx.lineTo(pad, h - pad); ctx.lineTo(w - 10, h - pad); 
            ctx.stroke();

            // Draw Axes Arrowheads (Black)
            ctx.beginPath();
            ctx.fillStyle = '#000000';
            // Y-axis arrow
            ctx.moveTo(pad - 3, 15); ctx.lineTo(pad, 10); ctx.lineTo(pad + 3, 15);
            // X-axis arrow
            ctx.moveTo(w - 15, h - pad - 3); ctx.lineTo(w - 10, h - pad); ctx.lineTo(w - 15, h - pad + 3);
            ctx.fill();

            // Grid lines remain lighter gray
            ctx.strokeStyle = '#e2e8f0';
            for (let i=1; i<=5; i++) {
                const y = (h-pad) - ((h-pad-10)/5 * i);
                ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(w-10, y); ctx.stroke();
            }

            const maxV = Math.max(state.expA.maxVol, state.expB.maxVol, 20); 
            const yScale = (h - pad - 10) / (maxV * 1.1); 
            const xScale = (w - pad - 10) / MAX_TIME;

            const drawCurve = (exp, color, isDashed = false) => {
                ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = isDashed ? 2 : 3;
                
                const timeEnd = (state.isRunning && !isDashed) ? state.currentTime : MAX_TIME;
                
                ctx.moveTo(pad, h - pad);
                
                if (isDashed) {
                    ctx.setLineDash([5, 5]);
                    ctx.globalAlpha = 0.5;
                } else {
                    ctx.setLineDash([]);
                    ctx.globalAlpha = 1.0;
                }

                for (let t = 0; t <= timeEnd; t += 1) {
                    const vol = exp.maxVol * (1 - Math.exp(-exp.k * t));
                    ctx.lineTo(pad + (t * xScale), (h - pad) - (vol * yScale));
                }
                ctx.stroke(); 
                ctx.setLineDash([]);
                ctx.globalAlpha = 1.0;

                // Draw dot if running
                if (state.isRunning && !isDashed) {
                    const volNow = exp.currentVol;
                    ctx.beginPath(); ctx.fillStyle = color;
                    ctx.arc(pad + (state.currentTime * xScale), (h - pad) - (volNow * yScale), 4, 0, Math.PI*2);
                    ctx.fill();
                }
            };

            // Draw real-time curves if running
            if (state.isRunning) {
                drawCurve(state.expA, '#2563eb', false);
                drawCurve(state.expB, '#dc2626', false);
            } 
            // Draw preview curves if toggled and NOT running
            else if (state.showPreview) {
                drawCurve(state.expA, '#2563eb', false); // Solid for preview
                drawCurve(state.expB, '#dc2626', false);
            }
        }

        // --- BUBBLES ---
        let bubblesA_arr = [];
        let bubblesB_arr = [];
        function animateBubbles(exp, canvas, color) {
            const ctx = canvas.getContext('2d');
            const w = canvas.width; const h = canvas.height;
            const arr = color === 'blue' ? bubblesA_arr : bubblesB_arr;
            ctx.clearRect(0, 0, w, h);
            const rate = exp.maxVol * exp.k * Math.exp(-exp.k * state.currentTime);
            const spawnCount = Math.floor(rate * 2); 
            for(let i=0; i<spawnCount; i++) {
                if (Math.random() > 0.5) {
                    arr.push({ x: Math.random() * w, y: h, r: 1 + Math.random() * 2, v: 1 + Math.random() * 2, alpha: 1 });
                }
            }
            ctx.fillStyle = color === 'blue' ? 'rgba(37, 99, 235, 0.5)' : 'rgba(220, 38, 38, 0.5)';
            for (let i = arr.length - 1; i >= 0; i--) {
                const b = arr[i]; b.y -= b.v; b.x += (Math.random() - 0.5); 
                if (b.y < 0) b.alpha -= 0.1;
                ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.fill();
                if (b.y < -10 || b.alpha <= 0) arr.splice(i, 1);
            }
        }

        function resizeCanvases() {
            const container = els.graphCanvas.parentElement;
            els.graphCanvas.width = container.clientWidth; els.graphCanvas.height = container.clientHeight;
            [els.bubblesA, els.bubblesB].forEach(b => { b.width = b.parentElement.clientWidth; b.height = b.parentElement.clientHeight; });
            if (!state.isRunning) drawGraph();
        }

        init();

    </script>
</body>
</html>

